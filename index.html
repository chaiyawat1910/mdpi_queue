// ... (ส่วน Import และ Config เหมือนเดิม) ...

    // --- ส่วนที่ปรับปรุง: EDIT FUNCTIONALITY (FETCH REAL DATA) ---
    
    window.openEdit = async (id) => {
        const btnEdit = event.target; // ปุ่มที่กด
        const originalText = btnEdit.innerText;
        btnEdit.innerText = "⏳...";
        btnEdit.disabled = true;

        try {
            // ✅ CHANGE: ดึงข้อมูลสดจาก Database แทนการใช้ข้อมูลในตาราง (Prevent Stale Data)
            const docRef = doc(db, "queues", id);
            const docSnap = await getDoc(docRef); // เพิ่ม import getDoc ด้วยนะครับ

            if (!docSnap.exists()) {
                alert("❌ ไม่พบข้อมูล (อาจถูกลบไปแล้ว)");
                return;
            }

            const data = docSnap.data();

            // นำข้อมูลสดมาใส่ใน Modal
            document.getElementById("editId").value = id;
            document.getElementById("editName").value = data.name;
            document.getElementById("editEmail").value = data.email;
            document.getElementById("editDept").value = data.department;
            document.getElementById("editLoc").value = data.location;
            document.getElementById("editTime").value = data.timeSlot;

            document.getElementById("editModal").style.display = "flex";
        } catch (e) {
            console.error(e);
            alert("เกิดข้อผิดพลาดในการดึงข้อมูล: " + e.message);
        } finally {
            // คืนค่าปุ่มเดิม
            btnEdit.innerText = originalText;
            btnEdit.disabled = false;
        }
    };

    window.saveEdit = async () => {
        const id = document.getElementById("editId").value;
        const btnSave = event.target; // ปุ่ม Save
        
        // เก็บค่าเพื่อตรวจสอบความเปลี่ยนแปลง (Audit)
        const updates = {
            name: document.getElementById("editName").value.trim(),
            email: document.getElementById("editEmail").value.trim(),
            department: document.getElementById("editDept").value,
            location: document.getElementById("editLoc").value,
            timeSlot: document.getElementById("editTime").value,
            updatedAt: serverTimestamp() // ✅ เพิ่ม timestamp การแก้ไข
        };

        if(!updates.name || !updates.email) return alert("กรุณากรอกข้อมูลให้ครบ");

        btnSave.innerText = "กำลังบันทึก...";
        btnSave.disabled = true;

        try {
            // 1. ตรวจสอบการจองซ้ำ (Duplicate Check) ในขณะแก้ไขด้วย
            // ต้องเช็คว่าถ้าเปลี่ยนเวลา/สถานที่ ห้องนั้นต้องว่าง (ยกเว้นเป็นใบเดิมของตัวเอง)
            const qRef = collection(db, "queues");
            
            // เช็คห้องว่าง (Room Availability Check)
            const roomCheck = await getDocs(query(qRef, 
                where("date", "==", qDateInput.value), // วันที่เดิม (ถ้ามีแก้ข้ามวันต้องใช้ logic เพิ่ม)
                where("location", "==", updates.location),
                where("timeSlot", "==", updates.timeSlot)
            ));

            // Filter เอาเฉพาะใบที่ไม่ใช่ใบเดิม (Exclude current ID)
            const duplicateRoom = roomCheck.docs.find(d => d.id !== id);
            if(duplicateRoom) {
                throw new Error(`❌ แก้ไขไม่ได้: สถานที่ ${updates.location} รอบ ${updates.timeSlot} มีคนจองแล้ว`);
            }

            // 2. บันทึกข้อมูล (Update)
            await updateDoc(doc(db, "queues", id), updates);

            alert("✅ บันทึกการแก้ไขสำเร็จ");
            closeEditModal();
            
            // *หมายเหตุ: ตารางจะ Refresh อัตโนมัติด้วย onSnapshot ที่ทำงานอยู่แล้ว*

        } catch(e) {
            alert("เกิดข้อผิดพลาด: " + e.message);
        } finally {
            btnSave.innerText = "บันทึก";
            btnSave.disabled = false;
        }
    };
