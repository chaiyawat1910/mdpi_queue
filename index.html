<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MDPI ADMIN Queue System</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root {
    --glass: rgba(255,255,255,0.95);
    --primary: #007aff;
    --danger: #ff3b30;
    --success: #34c759;
    --warning: #ff9500;
    --disabled: #8e8e93;
    --bg-gradient: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
}
body {
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg-gradient);
    min-height: 100vh;
    color: #333;
    padding-bottom: 50px;
}
.container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 30px;
    background: rgba(255,255,255,0.25);
    backdrop-filter: blur(25px);
    border-radius: 24px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    border: 1px solid rgba(255, 255, 255, 0.18);
}
h1, h2 { margin-top: 0; color: #1d1d1f; }
input, select, button {
    width: 100%;
    padding: 12px;
    box-sizing: border-box;
    border-radius: 10px;
    border: 1px solid #ccc;
    margin: 6px 0;
    font-size: 15px;
}
input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0,122,255,0.2);
}
button {
    background: var(--primary);
    color: #fff;
    border: none;
    cursor: pointer;
    font-weight: 600;
    text-transform: uppercase;
    transition: 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
button:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-1px); }
button:disabled {
    background: var(--disabled);
    cursor: not-allowed;
    opacity: 0.7;
    transform: none;
}
button.danger { background: var(--danger); }
button.warning { background: var(--warning); color: #000; }
button.secondary { background: #6c757d; }

/* Table */
.table-wrapper { overflow-x: auto; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
table { width: 100%; border-collapse: collapse; background: #fff; }
th { background: #f8f9fa; font-weight: 600; color: #495057; padding: 12px; text-align: left; text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px; }
td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
tr:hover { background-color: #f8f9fa; }

.glass {
    background: #fff;
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}
.admin-only { display: none; }
.alert {
    background: var(--primary);
    color: #fff;
    padding: 15px;
    border-radius: 14px;
    text-align: center;
    font-size: 16px;
    display: none;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,122,255,0.4);
    animation: slideDown 0.3s ease-out;
}
@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.badge { padding: 6px 10px; border-radius: 6px; font-size: 0.85em; font-weight: 600; display: inline-block; }
.bg-loc { background-color: #e3f2fd; color: #0d47a1; }
.bg-time { background-color: #fff3e0; color: #e65100; }
.bg-dept { background-color: #f3e5f5; color: #4a148c; }

/* Modal Styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background: #fff;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}
</style>
</head>

<body>
<div class="container">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 2.5em; margin-bottom: 10px;">ü™ú MDPI Queue System</h1>
        <div style="font-size: 1em; color: #555; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 10px; display: inline-block;">
            üìÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≠‡∏á: <b>14 - 23 ‡∏°.‡∏Ñ. 2026</b> <br> 
            ‚è∞ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î: <b>14 ‡∏°.‡∏Ñ. (13:00) - 26 ‡∏°.‡∏Ñ. (18:00)</b>
        </div>
    </div>

    <div class="alert" id="notifyBox"></div>
    <div class="alert" id="systemStatusBox" style="background: #ff3b30; display:none;"></div>

    <div class="glass">
        <h2 style="color: var(--primary);">üìù ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ô‡πÑ‡∏î</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label style="font-size:0.9em; color:#666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</label>
                <input type="date" id="queueDate" style="font-weight:bold;">
            </div>
            <div>
                <label style="font-size:0.9em; color:#666;">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
                <select id="timeSlot">
                    <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (30 ‡∏ô‡∏≤‡∏ó‡∏µ/‡∏£‡∏≠‡∏ö) --</option>
                </select>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <input id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)">
            <input id="email" placeholder="Email ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <select id="department"></select>
            <select id="location">
                <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>
            </select>
        </div>

        <button id="addQueue" style="margin-top: 15px; padding: 15px; font-size: 1.1em;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
    </div>

    <div class="glass">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin:0;">üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span id="displayDate" style="color:var(--primary);">...</span>)</h2>
            <span style="font-size:0.9em; color:#666;">*‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö Real-time</span>
        </div>
        
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="width: 15%;">‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th style="width: 20%;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th style="width: 25%;">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</th>
                        <th style="width: 20%;">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                        <th class="admin-only" style="width: 20%;">Admin Action</th>
                    </tr>
                </thead>
                <tbody id="queueTable">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="glass admin-only" style="border: 2px solid var(--primary);">
        <h2 style="color: var(--primary);">‚öôÔ∏è Admin Control Panel</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
            <button onclick="exportCSV()">üìÇ Export CSV</button>
            <button onclick="exportExcel()">üìä Export Excel</button>
            <button class="danger" onclick="callNext()">üîî ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Notify)</button>
        </div>
    </div>

    <div class="glass">
        <h2 style="font-size: 1.2em;">üîê Admin Login</h2>
        <div style="display: flex; gap: 10px;">
            <input type="password" id="adminPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö" style="margin:0;">
            <button onclick="loginAdmin()" style="width: auto; margin:0; padding-left: 30px; padding-right: 30px;">Login</button>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="margin-top:0;">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h2>
        <input type="hidden" id="editId">
        
        <div style="margin-bottom: 10px;">
            <label style="font-size:0.9em; font-weight:bold;">‡∏ä‡∏∑‡πà‡∏≠:</label>
            <input id="editName">
        </div>
        <div style="margin-bottom: 10px;">
            <label style="font-size:0.9em; font-weight:bold;">Email:</label>
            <input id="editEmail">
        </div>
        <div style="margin-bottom: 10px;">
            <label style="font-size:0.9em; font-weight:bold;">‡πÅ‡∏ú‡∏ô‡∏Å:</label>
            <select id="editDept"></select>
        </div>
        <div style="margin-bottom: 10px;">
            <label style="font-size:0.9em; font-weight:bold;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
            <select id="editLoc"></select>
        </div>
        <div style="margin-bottom: 10px;">
            <label style="font-size:0.9em; font-weight:bold;">‡πÄ‡∏ß‡∏•‡∏≤:</label>
            <select id="editTime"></select>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 25px;">
            <button class="secondary" onclick="closeEditModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="saveEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { 
        getFirestore, collection, addDoc, deleteDoc, updateDoc, doc,
        query, where, orderBy, onSnapshot, getDocs, setDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ‚úÖ CONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyBWDvn67-_uW-OagSezI16kjbANVa4yAJI",
        authDomain: "my-queue-system-5b1d6.firebaseapp.com",
        projectId: "my-queue-system-5b1d6",
        storageBucket: "my-queue-system-5b1d6.firebasestorage.app",
        messagingSenderId: "57979958638",
        appId: "1:57979958638:web:82d71cc5654f304764fd7f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- SYSTEM CONSTANTS & RULES ---
    const ADMIN_PASSWORD = "Mdpi@dm1n1996"; 
    
    // 1. Time Slots & Locations
    const timeSlots = ["12:00 - 12:30", "15:00 - 15:20", "16:30 - 17:00", "17:00 - 17:30"];
    const locations = ["Tower A ‡∏ä‡∏±‡πâ‡∏ô 26", "Tower A ‡∏ä‡∏±‡πâ‡∏ô 27", "Tower B ‡∏ä‡∏±‡πâ‡∏ô 22"];
    
    // 2. Schedule Constraints
    const ALLOWED_DATE_START = "2026-01-14";
    const ALLOWED_DATE_END = "2026-01-23";
    const SYSTEM_OPEN_TIME = new Date("2026-01-14T13:00:00+07:00");
    const SYSTEM_CLOSE_TIME = new Date("2026-01-26T18:00:00+07:00");

    const departments = [
        "Editorial G1", "Editorial G2", "Editorial G3", "Editorial G4", "Editorial G5", 
        "Editorial G6", "Editorial G7", "Editorial G8", "Editorial G9", "Editorial G10", 
        "Editorial G11", "Editorial G12", "Editorial G13", "Editorial G14", "Editorial G15", 
        "Editorial G16", "Editorial G17", "Editorial G18", "Production G1", "Production G2", 
        "Production G3", "Production G4", "Production G5", "Production G6", "Admin", 
        "Conference", "Design", "Finance", "HR", "IT", "Proceedings", "Public Service", "Training"
    ];

    // --- INITIALIZATION ---
    function initDropdowns(prefix = "") {
        document.getElementById(prefix + "department").innerHTML = departments.map(d => `<option>${d}</option>`).join("");
        document.getElementById(prefix + "location").innerHTML = (prefix ? "" : `<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà --</option>`) + locations.map(l => `<option value="${l}">${l}</option>`).join("");
        document.getElementById(prefix + "timeSlot").innerHTML = (prefix ? "" : `<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ --</option>`) + timeSlots.map(t => `<option value="${t}">${t}</option>`).join("");
    }
    
    initDropdowns(); // Main Form
    initDropdowns("edit"); // Modal Form (Edit)

    const qDateInput = document.getElementById("queueDate");
    qDateInput.min = ALLOWED_DATE_START;
    qDateInput.max = ALLOWED_DATE_END;
    qDateInput.value = ALLOWED_DATE_START; // Default to start date

    let currentSnapshot = [];
    let unsubscribe = null;
    let isAdmin = false;

    // --- VALIDATION & UTILS ---
    function checkSystemStatus() {
        if (isAdmin) return true;
        const now = new Date();
        const btn = document.getElementById("addQueue");
        const statusBox = document.getElementById("systemStatusBox");

        if (now < SYSTEM_OPEN_TIME || now > SYSTEM_CLOSE_TIME) {
            btn.disabled = true;
            btn.innerHTML = "‚õî ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß <small>(‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£)</small>";
            statusBox.style.display = "block";
            statusBox.innerText = `‚õî ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: 14/01/26 (13:00) - 26/01/26 (18:00)`;
            return false;
        } else {
            btn.disabled = false;
            btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á";
            statusBox.style.display = "none";
            return true;
        }
    }
    
    setInterval(checkSystemStatus, 60000);
    checkSystemStatus();

    // --- CORE LOGIC: BOOKING (WITH STICT DUPLICATE CHECKS) ---
    document.getElementById("addQueue").onclick = async () => {
        if (!checkSystemStatus()) return;

        const name = document.getElementById("name").value.trim();
        const email = document.getElementById("email").value.trim();
        const dept = document.getElementById("department").value;
        const loc = document.getElementById("location").value;
        const time = document.getElementById("timeSlot").value;
        const date = qDateInput.value;

        // 1. Basic Validation
        if(!name || !email || !loc || !time || !date) return alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        if(date < ALLOWED_DATE_START || date > ALLOWED_DATE_END) {
            return alert(`‚ùå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (${ALLOWED_DATE_START} ‡∏ñ‡∏∂‡∏á ${ALLOWED_DATE_END})`);
        }

        const btn = document.getElementById("addQueue");
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...";

        try {
            const qRef = collection(db, "queues");

            // 2. CRITICAL: Slot Availability Check (Prevent Room Collision)
            const roomCheck = await getDocs(query(qRef, 
                where("date", "==", date),
                where("location", "==", loc),
                where("timeSlot", "==", time)
            ));
            if(!roomCheck.empty) {
                throw new Error(`‚ùå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà "${loc}" ‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ "${time}" ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß`);
            }

            // 3. CRITICAL: User Duplicate Check (Prevent Spam/Double Booking)
            const userCheck = await getDocs(query(qRef,
                where("date", "==", date),
                where("email", "==", email),
                where("timeSlot", "==", time)
            ));
            if(!userCheck.empty) {
                throw new Error(`‚ùå ‡∏Ñ‡∏∏‡∏ì (${email}) ‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ "${time}" ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ`);
            }

            // 4. Execute Booking
            await addDoc(qRef, {
                name, email, department: dept, location: loc, timeSlot: time, date,
                createdAt: serverTimestamp()
            });

            alert("‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö");
            // Clear only necessary fields
            document.getElementById("location").value = "";
            document.getElementById("timeSlot").value = "";

        } catch (e) {
            alert(e.message); // Show Specific Error Message
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
            checkSystemStatus();
        }
    };

    // --- REALTIME TABLE (VIEW BOOKINGS) ---
    const subscribeQueue = () => {
        if(unsubscribe) unsubscribe();
        document.getElementById("displayDate").innerText = qDateInput.value;

        // Query: Get all bookings for selected DATE
        const q = query(
            collection(db,"queues"),
            where("date","==", qDateInput.value),
            orderBy("timeSlot", "asc"),
            orderBy("location", "asc")
        );

        unsubscribe = onSnapshot(q, (snap) => {
            currentSnapshot = snap.docs;
            const tbody = document.getElementById("queueTable");
            tbody.innerHTML = "";
            
            if(snap.empty) {
                tbody.innerHTML = `<tr><td colspan='5' style='text-align:center; padding:40px; color:#999; background:#fafafa;'>
                    ‚ú® ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${qDateInput.value}) <br>‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                </td></tr>`;
            } else {
                snap.forEach(d => {
                    const data = d.data();
                    tbody.innerHTML += `
                    <tr>
                        <td><span class="badge bg-time">‚è∞ ${data.timeSlot}</span></td>
                        <td><span class="badge bg-loc">üìç ${data.location}</span></td>
                        <td style="font-weight:500;">${data.name}</td>
                        <td><span class="badge bg-dept">${data.department}</span></td>
                        <td class="admin-only" style="${isAdmin ? 'display:block' : ''}">
                            <div style="display:flex; gap:5px;">
                                <button class="warning" style="padding:5px 10px; font-size:0.8em;" onclick="openEdit('${d.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="danger" style="padding:5px 10px; font-size:0.8em;" onclick="deleteQ('${d.id}')">‡∏•‡∏ö</button>
                            </div>
                        </td>
                    </tr>`;
                });
            }
            if(isAdmin) document.querySelectorAll(".admin-only").forEach(e => e.style.display = "block");
        }, (error) => {
            console.error("Firebase Error:", error);
        });
    };

    // Trigger View on Date Change
    subscribeQueue();
    qDateInput.onchange = subscribeQueue;

    // --- ADMIN & UTILS ---
    window.loginAdmin = () => {
        if(document.getElementById("adminPass").value === ADMIN_PASSWORD){
            isAdmin = true;
            document.querySelectorAll(".admin-only").forEach(e => e.style.display = "block");
            alert("‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            subscribeQueue(); // Refresh view
        } else {
            alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        }
    };

    // Edit Functionality
    window.openEdit = (id) => {
        const docSnap = currentSnapshot.find(d => d.id === id);
        if(!docSnap) return;
        const data = docSnap.data();
        document.getElementById("editId").value = id;
        document.getElementById("editName").value = data.name;
        document.getElementById("editEmail").value = data.email;
        document.getElementById("editDept").value = data.department;
        document.getElementById("editLoc").value = data.location;
        document.getElementById("editTime").value = data.timeSlot;
        document.getElementById("editModal").style.display = "flex";
    };

    window.closeEditModal = () => document.getElementById("editModal").style.display = "none";

    window.saveEdit = async () => {
        const id = document.getElementById("editId").value;
        const updates = {
            name: document.getElementById("editName").value,
            email: document.getElementById("editEmail").value,
            department: document.getElementById("editDept").value,
            location: document.getElementById("editLoc").value,
            timeSlot: document.getElementById("editTime").value
        };
        try {
            await updateDoc(doc(db, "queues", id), updates);
            alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            closeEditModal();
        } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message); }
    };

    window.deleteQ = async (id) => {
        if(confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")) await deleteDoc(doc(db,"queues",id));
    };

    window.callNext = async () => {
        if(!currentSnapshot.length) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å");
        const first = currentSnapshot[0].data();
        await setDoc(doc(db,"notifications","current"), { ...first, calledAt: serverTimestamp() });
        await deleteDoc(currentSnapshot[0].ref);
    };

    // Export Logic
    window.exportCSV = () => {
        let csv = "\uFEFFDate,Time,Location,Name,Department,Email\n";
        currentSnapshot.forEach(d => {
            const q = d.data();
            csv += `"${q.date}","${q.timeSlot}","${q.location}","${q.name}","${q.department}","${q.email}"\n`;
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([csv],{type:"text/csv;charset=utf-8"}));
        a.download = `queue_${qDateInput.value}.csv`;
        a.click();
    };

    window.exportExcel = () => {
        const data = currentSnapshot.map(d => d.data());
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, `queue_${qDateInput.value}.xlsx`);
    };

    // Notification Listener
    onSnapshot(doc(db,"notifications","current"), snap => {
        if(!snap.exists()) return;
        const d = snap.data();
        const box = document.getElementById("notifyBox");
        box.style.display = "block";
        box.innerHTML = `üîî <b>‡∏Ç‡∏≠‡πÄ‡∏ä‡∏¥‡∏ç‡∏Ñ‡∏∏‡∏ì ${d.name}</b><br>üìç ${d.location} | ‚è∞ ${d.timeSlot}`;
        setTimeout(() => box.style.display = "none", 8000);
    });
</script>
</body>
</html>
