<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡πÑ‡∏î</title>

<script src="https://cdn.tailwindcss.com"></script>

<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
    "lucide-react": "https://esm.sh/lucide-react@0.294.0"
  }
}
</script>

<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-slate-100">
<div id="root"></div>

<script type="text/babel" data-type="module">
import React, { useState, useEffect } from "react";
import { createRoot } from "react-dom/client";
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously } from "firebase/auth";
import {
  getFirestore, collection, doc,
  setDoc, getDoc, onSnapshot, deleteDoc
} from "firebase/firestore";
import { Clock, Calendar, Building2, User, Users, CheckCircle, AlertCircle } from "lucide-react";

/* üîß Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBWDvn67-_uW-OagSezI16kjbANVa4yAJI",
  authDomain: "my-queue-system-5b1d6.firebaseapp.com",
  projectId: "my-queue-system-5b1d6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const COLLECTION = "stair_bookings";

/* ‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤ 30 ‡∏ô‡∏≤‡∏ó‡∏µ */
const INTERVAL = 30;
const generateSlots = () => {
  const ranges = [
    ["09:00","12:00"],
    ["13:00","17:00"]
  ];
  const slots = [];
  ranges.forEach(([s,e])=>{
    let cur = new Date(`2024-01-01T${s}`);
    const end = new Date(`2024-01-01T${e}`);
    while(cur < end){
      slots.push(cur.toTimeString().slice(0,5));
      cur.setMinutes(cur.getMinutes()+INTERVAL);
    }
  });
  return slots;
};

function App(){
  const [bookings,setBookings]=useState({});
  const [date,setDate]=useState(new Date().toISOString().split("T")[0]);
  const [tower,setTower]=useState("");
  const [time,setTime]=useState("");
  const [form,setForm]=useState({name:"",email:"",group:""});
  const [msg,setMsg]=useState("");
  const [err,setErr]=useState("");

  const slots = generateSlots();

  useEffect(()=>{
    signInAnonymously(auth);
    return onSnapshot(collection(db,COLLECTION),(snap)=>{
      const data={};
      snap.forEach(d=>data[d.id]=d.data());
      setBookings(data);
    });
  },[]);

  const book = async()=>{
    setErr(""); setMsg("");
    if(!date||!tower||!time||!form.name||!form.email||!form.group){
      setErr("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      return;
    }
    const id = `${date}_${tower}_${time}`;
    const ref = doc(db,COLLECTION,id);
    const snap = await getDoc(ref);
    if(snap.exists()){
      setErr("‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß");
      return;
    }
    await setDoc(ref,{...form,date,tower,time,created:new Date().toISOString()});
    setMsg(`‡∏à‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡πÑ‡∏î ${tower} ‡πÄ‡∏ß‡∏•‡∏≤ ${time} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    setTime("");
  };

  return (
  <div className="max-w-5xl mx-auto p-6 space-y-6">
    <h1 className="text-3xl font-bold flex gap-2">
      <Clock/> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ô‡πÑ‡∏î
    </h1>

    <div className="grid md:grid-cols-3 gap-4 bg-white p-5 rounded-xl shadow">
      <div>
        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
        <input type="date" value={date}
          onChange={e=>setDate(e.target.value)}
          className="w-full border p-2 rounded"/>
      </div>

      <div>
        <label>‡∏ï‡∏∂‡∏Å</label>
        <select value={tower}
          onChange={e=>setTower(e.target.value)}
          className="w-full border p-2 rounded">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏∂‡∏Å --</option>
          <option>Tower A</option>
          <option>Tower B</option>
        </select>
      </div>

      <div>
        <label>‡πÄ‡∏ß‡∏•‡∏≤</label>
        <select value={time}
          onChange={e=>setTime(e.target.value)}
          className="w-full border p-2 rounded">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ --</option>
          {slots.map(t=>{
            const id=`${date}_${tower}_${t}`;
            return <option key={t} disabled={bookings[id]}>{t}</option>
          })}
        </select>
      </div>
    </div>

    <div className="grid md:grid-cols-3 gap-4 bg-white p-5 rounded-xl shadow">
      <input placeholder="‡∏ä‡∏∑‡πà‡∏≠" className="border p-2 rounded"
        onChange={e=>setForm({...form,name:e.target.value})}/>
      <input placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" className="border p-2 rounded"
        onChange={e=>setForm({...form,email:e.target.value})}/>
      <input placeholder="‡∏Å‡∏•‡∏∏‡πà‡∏°" className="border p-2 rounded"
        onChange={e=>setForm({...form,group:e.target.value})}/>
    </div>

    {err && <div className="text-red-600 flex gap-2"><AlertCircle/>{err}</div>}
    {msg && <div className="text-green-600 flex gap-2"><CheckCircle/>{msg}</div>}

    <button onClick={book}
      className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (30 ‡∏ô‡∏≤‡∏ó‡∏µ)
    </button>
  </div>
  );
}

createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
